function [Y A B C D E F G H I J K L M N O S] = Dwt53_Nsp4D(Y,Sw,Fs,Fc,T)
%
%  Non Separable 4D Lifting (5/3)
%  

g=DwtCoef(0);% 0.5/3, 1.9/7
h=floor(g.*2^Fc)./2^Fc;
q=2^Fs;
[N1, N2, N3, N4]=size(Y); M1=N1/2; M2=N2/2; M3=N3/2; M4=N4/2;

%% Analysis

if(Sw==+1)

A=Y(1:2:N1, 1:2:N2, 1:2:N3, 1:2:N4);
B=Y(1:2:N1, 1:2:N2, 1:2:N3, 2:2:N4);
C=Y(1:2:N1, 1:2:N2, 2:2:N3, 1:2:N4);
D=Y(1:2:N1, 1:2:N2, 2:2:N3, 2:2:N4);
E=Y(1:2:N1, 2:2:N2, 1:2:N3, 1:2:N4);
F=Y(1:2:N1, 2:2:N2, 1:2:N3, 2:2:N4);
G=Y(1:2:N1, 2:2:N2, 2:2:N3, 1:2:N4);
H=Y(1:2:N1, 2:2:N2, 2:2:N3, 2:2:N4);
I=Y(2:2:N1, 1:2:N2, 1:2:N3, 1:2:N4);
J=Y(2:2:N1, 1:2:N2, 1:2:N3, 2:2:N4);
K=Y(2:2:N1, 1:2:N2, 2:2:N3, 1:2:N4);
L=Y(2:2:N1, 1:2:N2, 2:2:N3, 2:2:N4);
M=Y(2:2:N1, 2:2:N2, 1:2:N3, 1:2:N4);
N=Y(2:2:N1, 2:2:N2, 1:2:N3, 2:2:N4);
O=Y(2:2:N1, 2:2:N2, 2:2:N3, 1:2:N4);
S=Y(2:2:N1, 2:2:N2, 2:2:N3, 2:2:N4);

% 1st Lifting
%---------------------------
% S
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % A1 B1 C1 D1
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1)*h(1)*h(1)*h(1);

X=B; % A1 B1 C1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)  
P=P+X*h(1)*h(1)*h(1);

X=C; % A1 B1 D1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1)*h(1)*h(1);

X=D; % A1 B1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1) 
P=P+X*h(1)*h(1);

X=E; % A1 C1 D1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1) 
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1)*h(1)*h(1);

X=F; % A1 C1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(1)*h(1);

X=G; % A1 D1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1)*h(1);

X=H; % A1
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
P=P+X*h(1);

X=I; % B1 C1 D1
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1)*h(1)*h(1);

X=J; % B1 C1
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(1)*h(1);

X=K; % B1 D1
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1)*h(1);

X=L; % B1 
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
P=P+X*h(1);

X=M; %C1 D1
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1)*h(1);

X=N; %C1
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(1);

X=O; %D1
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1);

S=S+R(T,q,P);

%2nd Lifting
%---------------------------
% O
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % A1 B1 C1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)  
P=P+X*h(1)*h(1)*h(1);

X=C; % A1 B1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1) 
P=P+X*h(1)*h(1);

X=E; % A1 C1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(1)*h(1);

X=G; % A1
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
P=P+X*h(1);

X=I; % B1 C1
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(1)*h(1);

X=K; % B1 
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
P=P+X*h(1);

X=M; %C1
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(1);

X=S; % D2
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P+X*h(2);

O=O+R(T,q,P);

%---------------------------
% N
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % A1 B1 D1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1)*h(1)*h(1);

X=B; % A1 B1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1) 
P=P+X*h(1)*h(1);

X=E; % A1 D1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1)*h(1);

X=F; % A1
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
P=P+X*h(1);

X=I; % B1 D1
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1)*h(1);

X=J; % B1 
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
P=P+X*h(1);

X=M; % D1
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1);

X=S; % C2
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P+X*h(2);

N=N+R(T,q,P);

%---------------------------
% L
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % A1 C1 D1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1) 
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1)*h(1)*h(1);

X=B; % A1 C1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(1)*h(1);

X=C; % A1 D1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1)*h(1);

X=D; % A1
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
P=P+X*h(1);

X=I; %C1 D1
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1)*h(1);

X=J; % C1
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(1);

X=K; % D1
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1);

X=S; % B2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
P=P+X*h(2);

L=L+R(T,q,P);

%---------------------------
% H
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % B1 C1 D1
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1)*h(1)*h(1);

X=B; % B1 C1
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(1)*h(1);

X=C; % B1 D1
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1)*h(1);

X=D; % B1 
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
P=P+X*h(1);

X=E; %C1 D1
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1)*h(1);

X=F; % C1
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(1);

X=G; % D1
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1);

X=S; % A2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
P=P+X*h(2);

H=H+R(T,q,P);

% 3rd Lifting 
%---------------------------
% M
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % A1 B1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1) 
P=P+X*h(1)*h(1);

X=E; % A1
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
P=P+X*h(1);

X=I; % B1 
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
P=P+X*h(1);

X=N; % D2
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P+X*h(2);

X=O; % C2
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P+X*h(2);

X=S; % -C2 D2
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P -X*h(2)*h(2);

M=M+R(T,q,P);

%---------------------------
% K
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % A1 C1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(1)*h(1);

X=C; % A1
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
P=P+X*h(1);

X=I; % C1
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(1);

X=L; % D2
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P+X*h(2);

X=O; % B2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
P=P+X*h(2);

X=S; % -B2 D2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P -X*h(2)*h(2);

K=K+R(T,q,P);

%---------------------------
% J
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % A1 D1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1)*h(1);

X=B; % A1
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
P=P+X*h(1);

X=I; % D1
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1);

X=L; % C2
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P+X*h(2);

X=N; % B2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
P=P+X*h(2);

X=S; % -B2 C2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P -X*h(2)*h(2);

J=J+R(T,q,P);

%---------------------------
% G
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % B1 C1
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(1)*h(1);

X=C; % B1 
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
P=P+X*h(1);

X=E; % C1
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(1);

X=H; % D2
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P+X*h(2);

X=O; % A2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
P=P+X*h(2);

X=S; % -A2 D2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P -X*h(2)*h(2);

G=G+R(T,q,P);

%---------------------------
% F
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % B1 D1
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1)*h(1);

X=B; % B1 
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
P=P+X*h(1);

X=E; % D1
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1);

X=H; % C2
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P+X*h(2);

X=N; % A2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
P=P+X*h(2);

X=S; % -A2 C2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P -X*h(2)*h(2);

F=F+R(T,q,P);

%---------------------------
% D
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; %C1 D1
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1)*h(1);

X=B; % C1
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(1);

X=C; % D1
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1);

X=H; % B2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
P=P+X*h(2);

X=L; % A2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
P=P+X*h(2);

X=S; % -A2 B2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1) 
P=P -X*h(2)*h(2);

D=D+R(T,q,P);

%4th Lifting
%---------------------------
% I
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % A1
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
P=P+X*h(1);

X=J; % D2
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P+X*h(2);

X=K; % C2
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P+X*h(2);

X=L; % -C2 D2
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P -X*h(2)*h(2);

X=M; % B2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
P=P+X*h(2);

X=N; % -B2 D2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P -X*h(2)*h(2);

X=O; % -B2 C2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P -X*h(2)*h(2);

X=S; % B2 C2 D2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1) 
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P+X*h(2)*h(2)*h(2);

I=I+R(T,q,P);

%---------------------------
% E
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % B1 
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
P=P+X*h(1);

X=F; % D2
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P+X*h(2);

X=G; % C2
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P+X*h(2);

X=H; % -C2 D2
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P -X*h(2)*h(2);

X=M; % A2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
P=P+X*h(2);

X=N; % -A2 D2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P -X*h(2)*h(2);

X=O; % -A2 C2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P -X*h(2)*h(2);

X=S; % A2 C2 D2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P+X*h(2)*h(2)*h(2);

E=E+R(T,q,P);

%---------------------------
% C
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % C1
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(1);

X=D; % D2
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P+X*h(2);

X=G; % B2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
P=P+X*h(2);

X=H; % -B2 D2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P -X*h(2)*h(2);

X=K; % A2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
P=P+X*h(2);

X=L; % -A2 D2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P -X*h(2)*h(2);

X=O; % -A2 B2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1) 
P=P -X*h(2)*h(2);

X=S; % A2 B2 D2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1) 
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P+X*h(2)*h(2)*h(2);

C=C+R(T,q,P);

%---------------------------
% B
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % D1
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1);

X=D; % C2
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P+X*h(2);

X=F; % B2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
P=P+X*h(2);

X=H; % -B2 C2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P -X*h(2)*h(2);

X=J; % A2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
P=P+X*h(2);

X=L; % -A2 C2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P -X*h(2)*h(2);

X=N; % -A2 B2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1) 
P=P -X*h(2)*h(2);

X=S; % A2 B2 C2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1) 
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P+X*h(2)*h(2)*h(2);

B=B+R(T,q,P);

% 5th Lifting
%---------------------------
% A
%---------------------------
P=zeros(M1,M2,M3,M4);

X=B; % D2
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P+X*h(2);

X=C; % C2
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P+X*h(2);

X=D; % -C2 D2
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P -X*h(2)*h(2);

X=E; % B2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
P=P+X*h(2);

X=F; % -B2 D2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P -X*h(2)*h(2);

X=G; % -B2 C2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P -X*h(2)*h(2);

X=H; % B2 C2 D2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1) 
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P+X*h(2)*h(2)*h(2);

X=I; % A2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
P=P+X*h(2);

X=J; % -A2 D2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P -X*h(2)*h(2);

X=K; % -A2 C2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P -X*h(2)*h(2);

X=L; % A2 C2 D2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P+X*h(2)*h(2)*h(2);

X=M; % -A2 B2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1) 
P=P -X*h(2)*h(2);

X=N; % A2 B2 D2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1) 
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P+X*h(2)*h(2)*h(2);

X=O; % A2 B2 C2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1) 
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P+X*h(2)*h(2)*h(2);

X=S; % -A2 B2 C2 D2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1) 
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1) 
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)
P=P -X*h(2)*h(2)*h(2)*h(2);

A=A+R(T,q,P);
%---------------------------
%  
%---------------------------

Z(   1:M1,    1:M2,    1:M3,    1:M4) = A;
Z(   1:M1,    1:M2,    1:M3, 1+M4:N4) = B;
Z(   1:M1,    1:M2, 1+M3:N3,    1:M4) = C;
Z(   1:M1,    1:M2, 1+M3:N3, 1+M4:N4) = D;
Z(   1:M1, 1+M2:N2,    1:M3,    1:M4) = E;
Z(   1:M1, 1+M2:N2,    1:M3, 1+M4:N4) = F;
Z(   1:M1, 1+M2:N2, 1+M3:N3,    1:M4) = G;
Z(   1:M1, 1+M2:N2, 1+M3:N3, 1+M4:N4) = H;
Z(1+M1:N1,    1:M2,    1:M3,    1:M4) = I;
Z(1+M1:N1,    1:M2,    1:M3, 1+M4:N4) = J;
Z(1+M1:N1,    1:M2, 1+M3:N3,    1:M4) = K;
Z(1+M1:N1,    1:M2, 1+M3:N3, 1+M4:N4) = L;
Z(1+M1:N1, 1+M2:N2,    1:M3,    1:M4) = M;
Z(1+M1:N1, 1+M2:N2,    1:M3, 1+M4:N4) = N;
Z(1+M1:N1, 1+M2:N2, 1+M3:N3,    1:M4) = O;
Z(1+M1:N1, 1+M2:N2, 1+M3:N3, 1+M4:N4) = S;

Y = Z;

end
%% Synthesis
if(Sw==-1) 

A = Y(   1:M1,    1:M2,    1:M3,    1:M4);
B = Y(   1:M1,    1:M2,    1:M3, 1+M4:N4);
C = Y(   1:M1,    1:M2, 1+M3:N3,    1:M4);
D = Y(   1:M1,    1:M2, 1+M3:N3, 1+M4:N4);
E = Y(   1:M1, 1+M2:N2,    1:M3,    1:M4);
F = Y(   1:M1, 1+M2:N2,    1:M3, 1+M4:N4);
G = Y(   1:M1, 1+M2:N2, 1+M3:N3,    1:M4);
H = Y(   1:M1, 1+M2:N2, 1+M3:N3, 1+M4:N4);
I = Y(1+M1:N1,    1:M2,    1:M3,    1:M4);
J = Y(1+M1:N1,    1:M2,    1:M3, 1+M4:N4);
K = Y(1+M1:N1,    1:M2, 1+M3:N3,    1:M4);
L = Y(1+M1:N1,    1:M2, 1+M3:N3, 1+M4:N4);
M = Y(1+M1:N1, 1+M2:N2,    1:M3,    1:M4);
N = Y(1+M1:N1, 1+M2:N2,    1:M3, 1+M4:N4);
O = Y(1+M1:N1, 1+M2:N2, 1+M3:N3,    1:M4);
S = Y(1+M1:N1, 1+M2:N2, 1+M3:N3, 1+M4:N4);

% 5th Lifting
%---------------------------
% A
%---------------------------
P=zeros(M1,M2,M3,M4);

X=B; % D2
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P+X*h(2);

X=C; % C2
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P+X*h(2);

X=D; % -C2 D2
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P -X*h(2)*h(2);

X=E; % B2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
P=P+X*h(2);

X=F; % -B2 D2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P -X*h(2)*h(2);

X=G; % -B2 C2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P -X*h(2)*h(2);

X=H; % B2 C2 D2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1) 
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P+X*h(2)*h(2)*h(2);

X=I; % A2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
P=P+X*h(2);

X=J; % -A2 D2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P -X*h(2)*h(2);

X=K; % -A2 C2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P -X*h(2)*h(2);

X=L; % A2 C2 D2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P+X*h(2)*h(2)*h(2);

X=M; % -A2 B2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1) 
P=P -X*h(2)*h(2);

X=N; % A2 B2 D2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1) 
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P+X*h(2)*h(2)*h(2);

X=O; % A2 B2 C2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1) 
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P+X*h(2)*h(2)*h(2);

X=S; % -A2 B2 C2 D2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1) 
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1) 
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)
P=P -X*h(2)*h(2)*h(2)*h(2);

A=A-R(T,q,P);

%4th Lifting
%---------------------------
% B
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % D1
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1);

X=D; % C2
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P+X*h(2);

X=F; % B2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
P=P+X*h(2);

X=H; % -B2 C2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P -X*h(2)*h(2);

X=J; % A2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
P=P+X*h(2);

X=L; % -A2 C2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P -X*h(2)*h(2);

X=N; % -A2 B2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1) 
P=P -X*h(2)*h(2);

X=S; % A2 B2 C2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1) 
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P+X*h(2)*h(2)*h(2);

B=B-R(T,q,P);

%---------------------------
% C
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % C1
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(1);

X=D; % D2
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P+X*h(2);

X=G; % B2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
P=P+X*h(2);

X=H; % -B2 D2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P -X*h(2)*h(2);

X=K; % A2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
P=P+X*h(2);

X=L; % -A2 D2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P -X*h(2)*h(2);

X=O; % -A2 B2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1) 
P=P -X*h(2)*h(2);

X=S; % A2 B2 D2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1) 
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P+X*h(2)*h(2)*h(2);

C=C-R(T,q,P);

%---------------------------
% E
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % B1 
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
P=P+X*h(1);

X=F; % D2
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P+X*h(2);

X=G; % C2
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P+X*h(2);

X=H; % -C2 D2
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P -X*h(2)*h(2);

X=M; % A2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
P=P+X*h(2);

X=N; % -A2 D2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P -X*h(2)*h(2);

X=O; % -A2 C2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P -X*h(2)*h(2);

X=S; % A2 C2 D2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P+X*h(2)*h(2)*h(2);

E=E-R(T,q,P);

%---------------------------
% I
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % A1
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
P=P+X*h(1);

X=J; % D2
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P+X*h(2);

X=K; % C2
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P+X*h(2);

X=L; % -C2 D2
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P -X*h(2)*h(2);

X=M; % B2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
P=P+X*h(2);

X=N; % -B2 D2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P -X*h(2)*h(2);

X=O; % -B2 C2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P -X*h(2)*h(2);

X=S; % B2 C2 D2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1) 
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P+X*h(2)*h(2)*h(2);

I=I-R(T,q,P);

%3rd Lifting
%---------------------------
% D
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; %C1 D1
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1)*h(1);

X=B; % C1
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(1);

X=C; % D1
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1);

X=H; % B2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
P=P+X*h(2);

X=L; % A2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
P=P+X*h(2);

X=S; % -A2 B2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1) 
P=P -X*h(2)*h(2);

D=D-R(T,q,P);

%---------------------------
% F
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % B1 D1
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1)*h(1);

X=B; % B1 
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
P=P+X*h(1);

X=E; % D1
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1);

X=H; % C2
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P+X*h(2);

X=N; % A2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
P=P+X*h(2);

X=S; % -A2 C2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P -X*h(2)*h(2);

F=F-R(T,q,P);

%---------------------------
% G
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % B1 C1
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(1)*h(1);

X=C; % B1 
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
P=P+X*h(1);

X=E; % C1
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(1);

X=H; % D2
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P+X*h(2);

X=O; % A2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
P=P+X*h(2);

X=S; % -A2 D2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P -X*h(2)*h(2);

G=G-R(T,q,P);

%---------------------------
% J
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % A1 D1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1)*h(1);

X=B; % A1
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
P=P+X*h(1);

X=I; % D1
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1);

X=L; % C2
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P+X*h(2);

X=N; % B2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
P=P+X*h(2);

X=S; % -B2 C2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P -X*h(2)*h(2);

J=J-R(T,q,P);

%---------------------------
% K
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % A1 C1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(1)*h(1);

X=C; % A1
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
P=P+X*h(1);

X=I; % C1
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(1);

X=L; % D2
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P+X*h(2);

X=O; % B2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
P=P+X*h(2);

X=S; % -B2 D2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P -X*h(2)*h(2);

K=K-R(T,q,P);

%---------------------------
% M
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % A1 B1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1) 
P=P+X*h(1)*h(1);

X=E; % A1
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
P=P+X*h(1);

X=I; % B1 
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
P=P+X*h(1);

X=N; % D2
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P+X*h(2);

X=O; % C2
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P+X*h(2);

X=S; % -C2 D2
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P -X*h(2)*h(2);

M=M-R(T,q,P);

%2nd Lifting
%---------------------------
% H
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % B1 C1 D1
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1)*h(1)*h(1);

X=B; % B1 C1
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(1)*h(1);

X=C; % B1 D1
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1)*h(1);

X=D; % B1 
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
P=P+X*h(1);

X=E; %C1 D1
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1)*h(1);

X=F; % C1
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(1);

X=G; % D1
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1);

X=S; % A2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
P=P+X*h(2);

H=H-R(T,q,P);

%---------------------------
% L
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % A1 C1 D1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1) 
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1)*h(1)*h(1);

X=B; % A1 C1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(1)*h(1);

X=C; % A1 D1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1)*h(1);

X=D; % A1
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
P=P+X*h(1);

X=I; %C1 D1
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1)*h(1);

X=J; % C1
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(1);

X=K; % D1
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1);

X=S; % B2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
P=P+X*h(2);

L=L-R(T,q,P);

%---------------------------
% N
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % A1 B1 D1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1)*h(1)*h(1);

X=B; % A1 B1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1) 
P=P+X*h(1)*h(1);

X=E; % A1 D1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1)*h(1);

X=F; % A1
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
P=P+X*h(1);

X=I; % B1 D1
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1)*h(1);

X=J; % B1 
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
P=P+X*h(1);

X=M; % D1
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1);

X=S; % C2
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P+X*h(2);

N=N-R(T,q,P);

%---------------------------
% O
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % A1 B1 C1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)  
P=P+X*h(1)*h(1)*h(1);

X=C; % A1 B1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1) 
P=P+X*h(1)*h(1);

X=E; % A1 C1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(1)*h(1);

X=G; % A1
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
P=P+X*h(1);

X=I; % B1 C1
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(1)*h(1);

X=K; % B1 
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
P=P+X*h(1);

X=M; %C1
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(1);

X=S; % D2
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P+X*h(2);

O=O-R(T,q,P);

%1st Lifting
%---------------------------
% S
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % A1 B1 C1 D1
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1)*h(1)*h(1)*h(1);

X=B; % A1 B1 C1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)  
P=P+X*h(1)*h(1)*h(1);

X=C; % A1 B1 D1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1)*h(1)*h(1);

X=D; % A1 B1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1) 
P=P+X*h(1)*h(1);

X=E; % A1 C1 D1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1) 
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1)*h(1)*h(1);

X=F; % A1 C1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(1)*h(1);

X=G; % A1 D1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1)*h(1);

X=H; % A1
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
P=P+X*h(1);

X=I; % B1 C1 D1
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1)*h(1)*h(1);

X=J; % B1 C1
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(1)*h(1);

X=K; % B1 D1
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1)*h(1);

X=L; % B1 
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
P=P+X*h(1);

X=M; %C1 D1
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1)*h(1);

X=N; %C1
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(1);

X=O; %D1
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1);

S=S-R(T,q,P);

%Reconstruction

Z(1:2:N1, 1:2:N2, 1:2:N3, 1:2:N4) = A;
Z(1:2:N1, 1:2:N2, 1:2:N3, 2:2:N4) = B;
Z(1:2:N1, 1:2:N2, 2:2:N3, 1:2:N4) = C;
Z(1:2:N1, 1:2:N2, 2:2:N3, 2:2:N4) = D;
Z(1:2:N1, 2:2:N2, 1:2:N3, 1:2:N4) = E;
Z(1:2:N1, 2:2:N2, 1:2:N3, 2:2:N4) = F;
Z(1:2:N1, 2:2:N2, 2:2:N3, 1:2:N4) = G;
Z(1:2:N1, 2:2:N2, 2:2:N3, 2:2:N4) = H;
Z(2:2:N1, 1:2:N2, 1:2:N3, 1:2:N4) = I;
Z(2:2:N1, 1:2:N2, 1:2:N3, 2:2:N4) = J;
Z(2:2:N1, 1:2:N2, 2:2:N3, 1:2:N4) = K;
Z(2:2:N1, 1:2:N2, 2:2:N3, 2:2:N4) = L;
Z(2:2:N1, 2:2:N2, 1:2:N3, 1:2:N4) = M;
Z(2:2:N1, 2:2:N2, 1:2:N3, 2:2:N4) = N;
Z(2:2:N1, 2:2:N2, 2:2:N3, 1:2:N4) = O;
Z(2:2:N1, 2:2:N2, 2:2:N3, 2:2:N4) = S;

Y=Z;

end

