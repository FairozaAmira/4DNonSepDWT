function [Y A B C D E F G H I J K L M N O S] = Dwt97_Sep4D(X, Sw, Fs, Fc, T )
%
% Separable 4D Lifting (9/7)
%   

g=DwtCoef(1);% 0.5/3, 1.9/7
h=floor(g.*2^Fc)./2^Fc;
q=2^Fs;
[N1, N2, N3, N4]=size(X); M1=N1/2; M2=N2/2; M3=N3/2; M4=N4/2;



%% Analysis
if(Sw==+1)

A=X(1:2:N1, 1:2:N2, 1:2:N3, 1:2:N4);
B=X(1:2:N1, 1:2:N2, 1:2:N3, 2:2:N4);
C=X(1:2:N1, 1:2:N2, 2:2:N3, 1:2:N4);
D=X(1:2:N1, 1:2:N2, 2:2:N3, 2:2:N4);
E=X(1:2:N1, 2:2:N2, 1:2:N3, 1:2:N4);
F=X(1:2:N1, 2:2:N2, 1:2:N3, 2:2:N4);
G=X(1:2:N1, 2:2:N2, 2:2:N3, 1:2:N4);
H=X(1:2:N1, 2:2:N2, 2:2:N3, 2:2:N4);
I=X(2:2:N1, 1:2:N2, 1:2:N3, 1:2:N4);
J=X(2:2:N1, 1:2:N2, 1:2:N3, 2:2:N4);
K=X(2:2:N1, 1:2:N2, 2:2:N3, 1:2:N4);
L=X(2:2:N1, 1:2:N2, 2:2:N3, 2:2:N4);
M=X(2:2:N1, 2:2:N2, 1:2:N3, 1:2:N4);
N=X(2:2:N1, 2:2:N2, 1:2:N3, 2:2:N4);
O=X(2:2:N1, 2:2:N2, 2:2:N3, 1:2:N4);
S=X(2:2:N1, 2:2:N2, 2:2:N3, 2:2:N4);

P=zeros(M1,M2,M3,M4);
%1st
X=A; P(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P(M1,:,:,:)=2*X(M1,:,:,:); I=I +R(T,q,P*h(1)); 
X=B; P(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P(M1,:,:,:)=2*X(M1,:,:,:); J=J +R(T,q,P*h(1));
X=C; P(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P(M1,:,:,:)=2*X(M1,:,:,:); K=K +R(T,q,P*h(1)); 
X=D; P(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P(M1,:,:,:)=2*X(M1,:,:,:); L=L +R(T,q,P*h(1)); 
X=E; P(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P(M1,:,:,:)=2*X(M1,:,:,:); M=M +R(T,q,P*h(1)); 
X=F; P(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P(M1,:,:,:)=2*X(M1,:,:,:); N=N +R(T,q,P*h(1));
X=G; P(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P(M1,:,:,:)=2*X(M1,:,:,:); O=O +R(T,q,P*h(1)); 
X=H; P(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P(M1,:,:,:)=2*X(M1,:,:,:); S=S +R(T,q,P*h(1)); 

%2nd
X=I; P(2:M1  ,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P( 1,:,:,:)=2*X( 1,:,:,:); A=A +R(T,q,P*h(2)); 
X=J; P(2:M1  ,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P( 1,:,:,:)=2*X( 1,:,:,:); B=B +R(T,q,P*h(2)); 
X=K; P(2:M1  ,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P( 1,:,:,:)=2*X( 1,:,:,:); C=C +R(T,q,P*h(2)); 
X=L; P(2:M1  ,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P( 1,:,:,:)=2*X( 1,:,:,:); D=D +R(T,q,P*h(2)); 
X=M; P(2:M1  ,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P( 1,:,:,:)=2*X( 1,:,:,:); E=E +R(T,q,P*h(2)); 
X=N; P(2:M1  ,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P( 1,:,:,:)=2*X( 1,:,:,:); F=F +R(T,q,P*h(2)); 
X=O; P(2:M1  ,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P( 1,:,:,:)=2*X( 1,:,:,:); G=G +R(T,q,P*h(2)); 
X=S; P(2:M1  ,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P( 1,:,:,:)=2*X( 1,:,:,:); H=H +R(T,q,P*h(2)); 

%3rd
X=A; P(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P(M1,:,:,:)=2*X(M1,:,:,:); I=I +R(T,q,P*h(3)); 
X=B; P(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P(M1,:,:,:)=2*X(M1,:,:,:); J=J +R(T,q,P*h(3));
X=C; P(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P(M1,:,:,:)=2*X(M1,:,:,:); K=K +R(T,q,P*h(3)); 
X=D; P(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P(M1,:,:,:)=2*X(M1,:,:,:); L=L +R(T,q,P*h(3)); 
X=E; P(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P(M1,:,:,:)=2*X(M1,:,:,:); M=M +R(T,q,P*h(3)); 
X=F; P(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P(M1,:,:,:)=2*X(M1,:,:,:); N=N +R(T,q,P*h(3));
X=G; P(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P(M1,:,:,:)=2*X(M1,:,:,:); O=O +R(T,q,P*h(3)); 
X=H; P(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P(M1,:,:,:)=2*X(M1,:,:,:); S=S +R(T,q,P*h(3)); 

%4th
X=I; P(2:M1  ,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P( 1,:,:,:)=2*X( 1,:,:,:); A=A +R(T,q,P*h(4)); 
X=J; P(2:M1  ,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P( 1,:,:,:)=2*X( 1,:,:,:); B=B +R(T,q,P*h(4)); 
X=K; P(2:M1  ,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P( 1,:,:,:)=2*X( 1,:,:,:); C=C +R(T,q,P*h(4)); 
X=L; P(2:M1  ,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P( 1,:,:,:)=2*X( 1,:,:,:); D=D +R(T,q,P*h(4)); 
X=M; P(2:M1  ,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P( 1,:,:,:)=2*X( 1,:,:,:); E=E +R(T,q,P*h(4)); 
X=N; P(2:M1  ,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P( 1,:,:,:)=2*X( 1,:,:,:); F=F +R(T,q,P*h(4)); 
X=O; P(2:M1  ,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P( 1,:,:,:)=2*X( 1,:,:,:); G=G +R(T,q,P*h(4)); 
X=S; P(2:M1  ,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P( 1,:,:,:)=2*X( 1,:,:,:); H=H +R(T,q,P*h(4)); 

A=R(T,q,A*h(6)); E=R(T,q,E*h(6)); I=R(T,q,I*h(5)); M=R(T,q,M*h(5)); 
B=R(T,q,B*h(6)); F=R(T,q,F*h(6)); J=R(T,q,J*h(5)); N=R(T,q,N*h(5)); 
C=R(T,q,C*h(6)); G=R(T,q,G*h(6)); K=R(T,q,K*h(5)); O=R(T,q,O*h(5)); 
D=R(T,q,D*h(6)); H=R(T,q,H*h(6)); L=R(T,q,L*h(5)); S=R(T,q,S*h(5)); 

%5th
X=A; P(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:,M2,:,:)=2*X(:,M2,:,:); E=E +R(T,q,P*h(1)); 
X=B; P(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:,M2,:,:)=2*X(:,M2,:,:); F=F +R(T,q,P*h(1)); 
X=C; P(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:,M2,:,:)=2*X(:,M2,:,:); G=G +R(T,q,P*h(1)); 
X=D; P(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:,M2,:,:)=2*X(:,M2,:,:); H=H +R(T,q,P*h(1)); 
X=I; P(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:,M2,:,:)=2*X(:,M2,:,:); M=M +R(T,q,P*h(1)); 
X=J; P(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:,M2,:,:)=2*X(:,M2,:,:); N=N +R(T,q,P*h(1)); 
X=K; P(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:,M2,:,:)=2*X(:,M2,:,:); O=O +R(T,q,P*h(1)); 
X=L; P(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:,M2,:,:)=2*X(:,M2,:,:); S=S +R(T,q,P*h(1)); 

%6th
X=E; P(:,2:M2  ,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:, 1,:,:)=2*X(:, 1,:,:); A=A +R(T,q,P*h(2)); 
X=F; P(:,2:M2  ,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:, 1,:,:)=2*X(:, 1,:,:); B=B +R(T,q,P*h(2)); 
X=G; P(:,2:M2  ,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:, 1,:,:)=2*X(:, 1,:,:); C=C +R(T,q,P*h(2)); 
X=H; P(:,2:M2  ,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:, 1,:,:)=2*X(:, 1,:,:); D=D +R(T,q,P*h(2)); 
X=M; P(:,2:M2  ,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:, 1,:,:)=2*X(:, 1,:,:); I=I +R(T,q,P*h(2)); 
X=N; P(:,2:M2  ,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:, 1,:,:)=2*X(:, 1,:,:); J=J +R(T,q,P*h(2)); 
X=O; P(:,2:M2  ,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:, 1,:,:)=2*X(:, 1,:,:); K=K +R(T,q,P*h(2)); 
X=S; P(:,2:M2  ,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:, 1,:,:)=2*X(:, 1,:,:); L=L +R(T,q,P*h(2)); 

%7th
X=A; P(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:,M2,:,:)=2*X(:,M2,:,:); E=E +R(T,q,P*h(3)); 
X=B; P(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:,M2,:,:)=2*X(:,M2,:,:); F=F +R(T,q,P*h(3)); 
X=C; P(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:,M2,:,:)=2*X(:,M2,:,:); G=G +R(T,q,P*h(3)); 
X=D; P(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:,M2,:,:)=2*X(:,M2,:,:); H=H +R(T,q,P*h(3)); 
X=I; P(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:,M2,:,:)=2*X(:,M2,:,:); M=M +R(T,q,P*h(3)); 
X=J; P(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:,M2,:,:)=2*X(:,M2,:,:); N=N +R(T,q,P*h(3)); 
X=K; P(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:,M2,:,:)=2*X(:,M2,:,:); O=O +R(T,q,P*h(3)); 
X=L; P(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:,M2,:,:)=2*X(:,M2,:,:); S=S +R(T,q,P*h(3)); 

%8th
X=E; P(:,2:M2  ,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:, 1,:,:)=2*X(:, 1,:,:); A=A +R(T,q,P*h(4)); 
X=F; P(:,2:M2  ,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:, 1,:,:)=2*X(:, 1,:,:); B=B +R(T,q,P*h(4)); 
X=G; P(:,2:M2  ,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:, 1,:,:)=2*X(:, 1,:,:); C=C +R(T,q,P*h(4)); 
X=H; P(:,2:M2  ,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:, 1,:,:)=2*X(:, 1,:,:); D=D +R(T,q,P*h(4)); 
X=M; P(:,2:M2  ,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:, 1,:,:)=2*X(:, 1,:,:); I=I +R(T,q,P*h(4)); 
X=N; P(:,2:M2  ,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:, 1,:,:)=2*X(:, 1,:,:); J=J +R(T,q,P*h(4)); 
X=O; P(:,2:M2  ,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:, 1,:,:)=2*X(:, 1,:,:); K=K +R(T,q,P*h(4)); 
X=S; P(:,2:M2  ,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:, 1,:,:)=2*X(:, 1,:,:); L=L +R(T,q,P*h(4)); 

A=R(T,q,A*h(6)); E=R(T,q,E*h(6)); I=R(T,q,I*h(5)); M=R(T,q,M*h(5)); 
B=R(T,q,B*h(6)); F=R(T,q,F*h(6)); J=R(T,q,J*h(5)); N=R(T,q,N*h(5)); 
C=R(T,q,C*h(6)); G=R(T,q,G*h(6)); K=R(T,q,K*h(5)); O=R(T,q,O*h(5)); 
D=R(T,q,D*h(6)); H=R(T,q,H*h(6)); L=R(T,q,L*h(5)); S=R(T,q,S*h(5)); 

%9th
X=A; P(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:,M3,:)=2*X(:,:,M3,:); C=C +R(T,q,P*h(1));
X=B; P(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:,M3,:)=2*X(:,:,M3,:); D=D +R(T,q,P*h(1)); 
X=E; P(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:,M3,:)=2*X(:,:,M3,:); G=G +R(T,q,P*h(1)); 
X=F; P(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:,M3,:)=2*X(:,:,M3,:); H=H +R(T,q,P*h(1)); 
X=I; P(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:,M3,:)=2*X(:,:,M3,:); K=K +R(T,q,P*h(1)); 
X=J; P(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:,M3,:)=2*X(:,:,M3,:); L=L +R(T,q,P*h(1));
X=M; P(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:,M3,:)=2*X(:,:,M3,:); O=O +R(T,q,P*h(1)); 
X=N; P(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:,M3,:)=2*X(:,:,M3,:); S=S +R(T,q,P*h(1)); 

%10th
X=C; P(:,:,2:M3  ,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:, 1,:)=2*X(:,:, 1,:); A=A +R(T,q,P*h(2)); 
X=D; P(:,:,2:M3  ,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:, 1,:)=2*X(:,:, 1,:); B=B +R(T,q,P*h(2)); 
X=G; P(:,:,2:M3  ,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:, 1,:)=2*X(:,:, 1,:); E=E +R(T,q,P*h(2)); 
X=H; P(:,:,2:M3  ,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:, 1,:)=2*X(:,:, 1,:); F=F +R(T,q,P*h(2)); 
X=K; P(:,:,2:M3  ,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:, 1,:)=2*X(:,:, 1,:); I=I +R(T,q,P*h(2)); 
X=L; P(:,:,2:M3  ,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:, 1,:)=2*X(:,:, 1,:); J=J +R(T,q,P*h(2)); 
X=O; P(:,:,2:M3  ,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:, 1,:)=2*X(:,:, 1,:); M=M +R(T,q,P*h(2)); 
X=S; P(:,:,2:M3  ,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:, 1,:)=2*X(:,:, 1,:); N=N +R(T,q,P*h(2)); 

%11th
X=A; P(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:,M3,:)=2*X(:,:,M3,:); C=C +R(T,q,P*h(3));
X=B; P(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:,M3,:)=2*X(:,:,M3,:); D=D +R(T,q,P*h(3)); 
X=E; P(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:,M3,:)=2*X(:,:,M3,:); G=G +R(T,q,P*h(3)); 
X=F; P(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:,M3,:)=2*X(:,:,M3,:); H=H +R(T,q,P*h(3)); 
X=I; P(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:,M3,:)=2*X(:,:,M3,:); K=K +R(T,q,P*h(3)); 
X=J; P(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:,M3,:)=2*X(:,:,M3,:); L=L +R(T,q,P*h(3));
X=M; P(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:,M3,:)=2*X(:,:,M3,:); O=O +R(T,q,P*h(3)); 
X=N; P(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:,M3,:)=2*X(:,:,M3,:); S=S +R(T,q,P*h(3)); 

%12th
X=C; P(:,:,2:M3  ,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:, 1,:)=2*X(:,:, 1,:); A=A +R(T,q,P*h(4)); 
X=D; P(:,:,2:M3  ,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:, 1,:)=2*X(:,:, 1,:); B=B +R(T,q,P*h(4)); 
X=G; P(:,:,2:M3  ,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:, 1,:)=2*X(:,:, 1,:); E=E +R(T,q,P*h(4)); 
X=H; P(:,:,2:M3  ,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:, 1,:)=2*X(:,:, 1,:); F=F +R(T,q,P*h(4)); 
X=K; P(:,:,2:M3  ,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:, 1,:)=2*X(:,:, 1,:); I=I +R(T,q,P*h(4)); 
X=L; P(:,:,2:M3  ,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:, 1,:)=2*X(:,:, 1,:); J=J +R(T,q,P*h(4)); 
X=O; P(:,:,2:M3  ,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:, 1,:)=2*X(:,:, 1,:); M=M +R(T,q,P*h(4)); 
X=S; P(:,:,2:M3  ,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:, 1,:)=2*X(:,:, 1,:); N=N +R(T,q,P*h(4)); 

A=R(T,q,A*h(6)); E=R(T,q,E*h(6)); I=R(T,q,I*h(5)); M=R(T,q,M*h(5)); 
B=R(T,q,B*h(6)); F=R(T,q,F*h(6)); J=R(T,q,J*h(5)); N=R(T,q,N*h(5)); 
C=R(T,q,C*h(6)); G=R(T,q,G*h(6)); K=R(T,q,K*h(5)); O=R(T,q,O*h(5)); 
D=R(T,q,D*h(6)); H=R(T,q,H*h(6)); L=R(T,q,L*h(5)); S=R(T,q,S*h(5)); 

%13th
X=A; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); B=B +R(T,q,P*h(1)); 
X=C; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); D=D +R(T,q,P*h(1)); 
X=E; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); F=F +R(T,q,P*h(1)); 
X=G; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); H=H +R(T,q,P*h(1)); 
X=I; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); J=J +R(T,q,P*h(1)); 
X=K; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); L=L +R(T,q,P*h(1)); 
X=M; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); N=N +R(T,q,P*h(1)); 
X=O; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); S=S +R(T,q,P*h(1)); 

%14th
X=B; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); A=A +R(T,q,P*h(2)); 
X=D; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); C=C +R(T,q,P*h(2)); 
X=F; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); E=E +R(T,q,P*h(2)); 
X=H; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); G=G +R(T,q,P*h(2)); 
X=J; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); I=I +R(T,q,P*h(2)); 
X=L; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); K=K +R(T,q,P*h(2)); 
X=N; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); M=M +R(T,q,P*h(2));
X=S; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); O=O +R(T,q,P*h(2)); 

%15th
X=A; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); B=B +R(T,q,P*h(3)); 
X=C; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); D=D +R(T,q,P*h(3)); 
X=E; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); F=F +R(T,q,P*h(3)); 
X=G; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); H=H +R(T,q,P*h(3)); 
X=I; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); J=J +R(T,q,P*h(3)); 
X=K; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); L=L +R(T,q,P*h(3)); 
X=M; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); N=N +R(T,q,P*h(3)); 
X=O; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); S=S +R(T,q,P*h(3)); 

%16th
X=B; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); A=A +R(T,q,P*h(4)); 
X=D; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); C=C +R(T,q,P*h(4)); 
X=F; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); E=E +R(T,q,P*h(4)); 
X=H; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); G=G +R(T,q,P*h(4)); 
X=J; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); I=I +R(T,q,P*h(4)); 
X=L; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); K=K +R(T,q,P*h(4)); 
X=N; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); M=M +R(T,q,P*h(4));
X=S; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); O=O +R(T,q,P*h(4)); 

A=R(T,q,A*h(6)); E=R(T,q,E*h(6)); I=R(T,q,I*h(5)); M=R(T,q,M*h(5)); 
B=R(T,q,B*h(6)); F=R(T,q,F*h(6)); J=R(T,q,J*h(5)); N=R(T,q,N*h(5)); 
C=R(T,q,C*h(6)); G=R(T,q,G*h(6)); K=R(T,q,K*h(5)); O=R(T,q,O*h(5)); 
D=R(T,q,D*h(6)); H=R(T,q,H*h(6)); L=R(T,q,L*h(5)); S=R(T,q,S*h(5)); 

Z=zeros(N1,N2,N3,N4);
Z(   1:M1,    1:M2,    1:M3,    1:M4) = A;
Z(   1:M1,    1:M2,    1:M3, 1+M4:N4) = B;
Z(   1:M1,    1:M2, 1+M3:N3,    1:M4) = C;
Z(   1:M1,    1:M2, 1+M3:N3, 1+M4:N4) = D;
Z(   1:M1, 1+M2:N2,    1:M3,    1:M4) = E;
Z(   1:M1, 1+M2:N2,    1:M3, 1+M4:N4) = F;
Z(   1:M1, 1+M2:N2, 1+M3:N3,    1:M4) = G;
Z(   1:M1, 1+M2:N2, 1+M3:N3, 1+M4:N4) = H;
Z(1+M1:N1,    1:M2,    1:M3,    1:M4) = I;
Z(1+M1:N1,    1:M2,    1:M3, 1+M4:N4) = J;
Z(1+M1:N1,    1:M2, 1+M3:N3,    1:M4) = K;
Z(1+M1:N1,    1:M2, 1+M3:N3, 1+M4:N4) = L;
Z(1+M1:N1, 1+M2:N2,    1:M3,    1:M4) = M;
Z(1+M1:N1, 1+M2:N2,    1:M3, 1+M4:N4) = N;
Z(1+M1:N1, 1+M2:N2, 1+M3:N3,    1:M4) = O;
Z(1+M1:N1, 1+M2:N2, 1+M3:N3, 1+M4:N4) = S;

Y = Z;

end
%% Synthesis
if(Sw==-1) 

A = X(   1:M1,    1:M2,    1:M3,    1:M4);
B = X(   1:M1,    1:M2,    1:M3, 1+M4:N4);
C = X(   1:M1,    1:M2, 1+M3:N3,    1:M4);
D = X(   1:M1,    1:M2, 1+M3:N3, 1+M4:N4);
E = X(   1:M1, 1+M2:N2,    1:M3,    1:M4);
F = X(   1:M1, 1+M2:N2,    1:M3, 1+M4:N4);
G = X(   1:M1, 1+M2:N2, 1+M3:N3,    1:M4);
H = X(   1:M1, 1+M2:N2, 1+M3:N3, 1+M4:N4);
I = X(1+M1:N1,    1:M2,    1:M3,    1:M4);
J = X(1+M1:N1,    1:M2,    1:M3, 1+M4:N4);
K = X(1+M1:N1,    1:M2, 1+M3:N3,    1:M4);
L = X(1+M1:N1,    1:M2, 1+M3:N3, 1+M4:N4);
M = X(1+M1:N1, 1+M2:N2,    1:M3,    1:M4);
N = X(1+M1:N1, 1+M2:N2,    1:M3, 1+M4:N4);
O = X(1+M1:N1, 1+M2:N2, 1+M3:N3,    1:M4);
S = X(1+M1:N1, 1+M2:N2, 1+M3:N3, 1+M4:N4);

P=zeros(M1,M2,M3,M4);

A=R(T,q,A*h(5)); E=R(T,q,E*h(5)); I=R(T,q,I*h(6)); M=R(T,q,M*h(6)); 
B=R(T,q,B*h(5)); F=R(T,q,F*h(5)); J=R(T,q,J*h(6)); N=R(T,q,N*h(6)); 
C=R(T,q,C*h(5)); G=R(T,q,G*h(5)); K=R(T,q,K*h(6)); O=R(T,q,O*h(6)); 
D=R(T,q,D*h(5)); H=R(T,q,H*h(5)); L=R(T,q,L*h(6)); S=R(T,q,S*h(6)); 

%16th
X=B; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); A=A -R(T,q,P*h(4)); 
X=D; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); C=C -R(T,q,P*h(4)); 
X=F; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); E=E -R(T,q,P*h(4)); 
X=H; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); G=G -R(T,q,P*h(4)); 
X=J; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); I=I -R(T,q,P*h(4)); 
X=L; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); K=K -R(T,q,P*h(4)); 
X=N; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); M=M -R(T,q,P*h(4)); 
X=S; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); O=O -R(T,q,P*h(4)); 

%15th
X=A; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); B=B -R(T,q,P*h(3)); 
X=C; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); D=D -R(T,q,P*h(3)); 
X=E; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); F=F -R(T,q,P*h(3)); 
X=G; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); H=H -R(T,q,P*h(3)); 
X=I; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); J=J -R(T,q,P*h(3)); 
X=K; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); L=L -R(T,q,P*h(3)); 
X=M; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); N=N -R(T,q,P*h(3)); 
X=O; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); S=S -R(T,q,P*h(3)); 

%14th
X=B; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); A=A -R(T,q,P*h(2)); 
X=D; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); C=C -R(T,q,P*h(2)); 
X=F; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); E=E -R(T,q,P*h(2)); 
X=H; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); G=G -R(T,q,P*h(2)); 
X=J; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); I=I -R(T,q,P*h(2)); 
X=L; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); K=K -R(T,q,P*h(2)); 
X=N; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); M=M -R(T,q,P*h(2)); 
X=S; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); O=O -R(T,q,P*h(2)); 

%13th
X=A; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); B=B -R(T,q,P*h(1)); 
X=C; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); D=D -R(T,q,P*h(1)); 
X=E; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); F=F -R(T,q,P*h(1)); 
X=G; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); H=H -R(T,q,P*h(1)); 
X=I; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); J=J -R(T,q,P*h(1)); 
X=K; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); L=L -R(T,q,P*h(1)); 
X=M; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); N=N -R(T,q,P*h(1)); 
X=O; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); S=S -R(T,q,P*h(1)); 

A=R(T,q,A*h(5)); E=R(T,q,E*h(5)); I=R(T,q,I*h(6)); M=R(T,q,M*h(6)); 
B=R(T,q,B*h(5)); F=R(T,q,F*h(5)); J=R(T,q,J*h(6)); N=R(T,q,N*h(6)); 
C=R(T,q,C*h(5)); G=R(T,q,G*h(5)); K=R(T,q,K*h(6)); O=R(T,q,O*h(6)); 
D=R(T,q,D*h(5)); H=R(T,q,H*h(5)); L=R(T,q,L*h(6)); S=R(T,q,S*h(6)); 

%12th
X=C; P(:,:,2:M3  ,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:, 1,:)=2*X(:,:, 1,:); A=A -R(T,q,P*h(4)); 
X=D; P(:,:,2:M3  ,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:, 1,:)=2*X(:,:, 1,:); B=B -R(T,q,P*h(4)); 
X=G; P(:,:,2:M3  ,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:, 1,:)=2*X(:,:, 1,:); E=E -R(T,q,P*h(4)); 
X=H; P(:,:,2:M3  ,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:, 1,:)=2*X(:,:, 1,:); F=F -R(T,q,P*h(4)); 
X=K; P(:,:,2:M3  ,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:, 1,:)=2*X(:,:, 1,:); I=I -R(T,q,P*h(4)); 
X=L; P(:,:,2:M3  ,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:, 1,:)=2*X(:,:, 1,:); J=J -R(T,q,P*h(4)); 
X=O; P(:,:,2:M3  ,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:, 1,:)=2*X(:,:, 1,:); M=M -R(T,q,P*h(4)); 
X=S; P(:,:,2:M3  ,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:, 1,:)=2*X(:,:, 1,:); N=N -R(T,q,P*h(4)); 

%11th
X=A; P(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:,M3,:)=2*X(:,:,M3,:); C=C -R(T,q,P*h(3));
X=B; P(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:,M3,:)=2*X(:,:,M3,:); D=D -R(T,q,P*h(3)); 
X=E; P(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:,M3,:)=2*X(:,:,M3,:); G=G -R(T,q,P*h(3)); 
X=F; P(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:,M3,:)=2*X(:,:,M3,:); H=H -R(T,q,P*h(3)); 
X=I; P(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:,M3,:)=2*X(:,:,M3,:); K=K -R(T,q,P*h(3)); 
X=J; P(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:,M3,:)=2*X(:,:,M3,:); L=L -R(T,q,P*h(3)); 
X=M; P(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:,M3,:)=2*X(:,:,M3,:); O=O -R(T,q,P*h(3)); 
X=N; P(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:,M3,:)=2*X(:,:,M3,:); S=S -R(T,q,P*h(3)); 

%10th
X=C; P(:,:,2:M3  ,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:, 1,:)=2*X(:,:, 1,:); A=A -R(T,q,P*h(2)); 
X=D; P(:,:,2:M3  ,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:, 1,:)=2*X(:,:, 1,:); B=B -R(T,q,P*h(2)); 
X=G; P(:,:,2:M3  ,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:, 1,:)=2*X(:,:, 1,:); E=E -R(T,q,P*h(2)); 
X=H; P(:,:,2:M3  ,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:, 1,:)=2*X(:,:, 1,:); F=F -R(T,q,P*h(2)); 
X=K; P(:,:,2:M3  ,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:, 1,:)=2*X(:,:, 1,:); I=I -R(T,q,P*h(2)); 
X=L; P(:,:,2:M3  ,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:, 1,:)=2*X(:,:, 1,:); J=J -R(T,q,P*h(2)); 
X=O; P(:,:,2:M3  ,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:, 1,:)=2*X(:,:, 1,:); M=M -R(T,q,P*h(2)); 
X=S; P(:,:,2:M3  ,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:, 1,:)=2*X(:,:, 1,:); N=N -R(T,q,P*h(2)); 

%9th
X=A; P(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:,M3,:)=2*X(:,:,M3,:); C=C -R(T,q,P*h(1));
X=B; P(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:,M3,:)=2*X(:,:,M3,:); D=D -R(T,q,P*h(1)); 
X=E; P(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:,M3,:)=2*X(:,:,M3,:); G=G -R(T,q,P*h(1)); 
X=F; P(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:,M3,:)=2*X(:,:,M3,:); H=H -R(T,q,P*h(1)); 
X=I; P(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:,M3,:)=2*X(:,:,M3,:); K=K -R(T,q,P*h(1)); 
X=J; P(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:,M3,:)=2*X(:,:,M3,:); L=L -R(T,q,P*h(1)); 
X=M; P(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:,M3,:)=2*X(:,:,M3,:); O=O -R(T,q,P*h(1)); 
X=N; P(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:);P(:,:,M3,:)=2*X(:,:,M3,:); S=S -R(T,q,P*h(1)); 

A=R(T,q,A*h(5)); E=R(T,q,E*h(5)); I=R(T,q,I*h(6)); M=R(T,q,M*h(6)); 
B=R(T,q,B*h(5)); F=R(T,q,F*h(5)); J=R(T,q,J*h(6)); N=R(T,q,N*h(6)); 
C=R(T,q,C*h(5)); G=R(T,q,G*h(5)); K=R(T,q,K*h(6)); O=R(T,q,O*h(6)); 
D=R(T,q,D*h(5)); H=R(T,q,H*h(5)); L=R(T,q,L*h(6)); S=R(T,q,S*h(6)); 

%8th
X=E; P(:,2:M2  ,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:, 1,:,:)=2*X(:, 1,:,:); A=A -R(T,q,P*h(4)); 
X=F; P(:,2:M2  ,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:, 1,:,:)=2*X(:, 1,:,:); B=B -R(T,q,P*h(4)); 
X=G; P(:,2:M2  ,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:, 1,:,:)=2*X(:, 1,:,:); C=C -R(T,q,P*h(4)); 
X=H; P(:,2:M2  ,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:, 1,:,:)=2*X(:, 1,:,:); D=D -R(T,q,P*h(4)); 
X=M; P(:,2:M2  ,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:, 1,:,:)=2*X(:, 1,:,:); I=I -R(T,q,P*h(4)); 
X=N; P(:,2:M2  ,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:, 1,:,:)=2*X(:, 1,:,:); J=J -R(T,q,P*h(4));
X=O; P(:,2:M2  ,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:, 1,:,:)=2*X(:, 1,:,:); K=K -R(T,q,P*h(4));
X=S; P(:,2:M2  ,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:, 1,:,:)=2*X(:, 1,:,:); L=L -R(T,q,P*h(4)); 

%7th
X=A; P(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:,M2,:,:)=2*X(:,M2,:,:); E=E -R(T,q,P*h(3)); 
X=B; P(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:,M2,:,:)=2*X(:,M2,:,:); F=F -R(T,q,P*h(3)); 
X=C; P(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:,M2,:,:)=2*X(:,M2,:,:); G=G -R(T,q,P*h(3)); 
X=D; P(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:,M2,:,:)=2*X(:,M2,:,:); H=H -R(T,q,P*h(3)); 
X=I; P(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:,M2,:,:)=2*X(:,M2,:,:); M=M -R(T,q,P*h(3)); 
X=J; P(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:,M2,:,:)=2*X(:,M2,:,:); N=N -R(T,q,P*h(3)); 
X=K; P(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:,M2,:,:)=2*X(:,M2,:,:); O=O -R(T,q,P*h(3)); 
X=L; P(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:,M2,:,:)=2*X(:,M2,:,:); S=S -R(T,q,P*h(3)); 

%6th
X=E; P(:,2:M2  ,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:, 1,:,:)=2*X(:, 1,:,:); A=A -R(T,q,P*h(2)); 
X=F; P(:,2:M2  ,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:, 1,:,:)=2*X(:, 1,:,:); B=B -R(T,q,P*h(2)); 
X=G; P(:,2:M2  ,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:, 1,:,:)=2*X(:, 1,:,:); C=C -R(T,q,P*h(2)); 
X=H; P(:,2:M2  ,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:, 1,:,:)=2*X(:, 1,:,:); D=D -R(T,q,P*h(2)); 
X=M; P(:,2:M2  ,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:, 1,:,:)=2*X(:, 1,:,:); I=I -R(T,q,P*h(2)); 
X=N; P(:,2:M2  ,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:, 1,:,:)=2*X(:, 1,:,:); J=J -R(T,q,P*h(2));
X=O; P(:,2:M2  ,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:, 1,:,:)=2*X(:, 1,:,:); K=K -R(T,q,P*h(2));
X=S; P(:,2:M2  ,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:, 1,:,:)=2*X(:, 1,:,:); L=L -R(T,q,P*h(2)); 

%5th
X=A; P(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:,M2,:,:)=2*X(:,M2,:,:); E=E -R(T,q,P*h(1)); 
X=B; P(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:,M2,:,:)=2*X(:,M2,:,:); F=F -R(T,q,P*h(1)); 
X=C; P(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:,M2,:,:)=2*X(:,M2,:,:); G=G -R(T,q,P*h(1)); 
X=D; P(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:,M2,:,:)=2*X(:,M2,:,:); H=H -R(T,q,P*h(1)); 
X=I; P(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:,M2,:,:)=2*X(:,M2,:,:); M=M -R(T,q,P*h(1)); 
X=J; P(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:,M2,:,:)=2*X(:,M2,:,:); N=N -R(T,q,P*h(1)); 
X=K; P(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:,M2,:,:)=2*X(:,M2,:,:); O=O -R(T,q,P*h(1)); 
X=L; P(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:);P(:,M2,:,:)=2*X(:,M2,:,:); S=S -R(T,q,P*h(1)); 

A=R(T,q,A*h(5)); E=R(T,q,E*h(5)); I=R(T,q,I*h(6)); M=R(T,q,M*h(6)); 
B=R(T,q,B*h(5)); F=R(T,q,F*h(5)); J=R(T,q,J*h(6)); N=R(T,q,N*h(6)); 
C=R(T,q,C*h(5)); G=R(T,q,G*h(5)); K=R(T,q,K*h(6)); O=R(T,q,O*h(6)); 
D=R(T,q,D*h(5)); H=R(T,q,H*h(5)); L=R(T,q,L*h(6)); S=R(T,q,S*h(6)); 

%4th
X=I; P(2:M1  ,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P( 1,:,:,:)=2*X( 1,:,:,:); A=A -R(T,q,P*h(4));
X=J; P(2:M1  ,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P( 1,:,:,:)=2*X( 1,:,:,:); B=B -R(T,q,P*h(4)); 
X=K; P(2:M1  ,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P( 1,:,:,:)=2*X( 1,:,:,:); C=C -R(T,q,P*h(4)); 
X=L; P(2:M1  ,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P( 1,:,:,:)=2*X( 1,:,:,:); D=D -R(T,q,P*h(4));
X=M; P(2:M1  ,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P( 1,:,:,:)=2*X( 1,:,:,:); E=E -R(T,q,P*h(4)); 
X=N; P(2:M1  ,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P( 1,:,:,:)=2*X( 1,:,:,:); F=F -R(T,q,P*h(4)); 
X=O; P(2:M1  ,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P( 1,:,:,:)=2*X( 1,:,:,:); G=G -R(T,q,P*h(4)); 
X=S; P(2:M1  ,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P( 1,:,:,:)=2*X( 1,:,:,:); H=H -R(T,q,P*h(4));

%3rd
X=A; P(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P(M1,:,:,:)=2*X(M1,:,:,:); I=I -R(T,q,P*h(3)); 
X=B; P(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P(M1,:,:,:)=2*X(M1,:,:,:); J=J -R(T,q,P*h(3)); 
X=C; P(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P(M1,:,:,:)=2*X(M1,:,:,:); K=K -R(T,q,P*h(3)); 
X=D; P(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P(M1,:,:,:)=2*X(M1,:,:,:); L=L -R(T,q,P*h(3)); 
X=E; P(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P(M1,:,:,:)=2*X(M1,:,:,:); M=M -R(T,q,P*h(3));
X=F; P(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P(M1,:,:,:)=2*X(M1,:,:,:); N=N -R(T,q,P*h(3)); 
X=G; P(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P(M1,:,:,:)=2*X(M1,:,:,:); O=O -R(T,q,P*h(3)); 
X=H; P(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P(M1,:,:,:)=2*X(M1,:,:,:); S=S -R(T,q,P*h(3)); 

%2nd
X=I; P(2:M1  ,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P( 1,:,:,:)=2*X( 1,:,:,:); A=A -R(T,q,P*h(2));
X=J; P(2:M1  ,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P( 1,:,:,:)=2*X( 1,:,:,:); B=B -R(T,q,P*h(2)); 
X=K; P(2:M1  ,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P( 1,:,:,:)=2*X( 1,:,:,:); C=C -R(T,q,P*h(2)); 
X=L; P(2:M1  ,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P( 1,:,:,:)=2*X( 1,:,:,:); D=D -R(T,q,P*h(2));
X=M; P(2:M1  ,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P( 1,:,:,:)=2*X( 1,:,:,:); E=E -R(T,q,P*h(2)); 
X=N; P(2:M1  ,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P( 1,:,:,:)=2*X( 1,:,:,:); F=F -R(T,q,P*h(2)); 
X=O; P(2:M1  ,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P( 1,:,:,:)=2*X( 1,:,:,:); G=G -R(T,q,P*h(2)); 
X=S; P(2:M1  ,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P( 1,:,:,:)=2*X( 1,:,:,:); H=H -R(T,q,P*h(2));

%1st
X=A; P(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P(M1,:,:,:)=2*X(M1,:,:,:); I=I -R(T,q,P*h(1)); 
X=B; P(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P(M1,:,:,:)=2*X(M1,:,:,:); J=J -R(T,q,P*h(1)); 
X=C; P(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P(M1,:,:,:)=2*X(M1,:,:,:); K=K -R(T,q,P*h(1)); 
X=D; P(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P(M1,:,:,:)=2*X(M1,:,:,:); L=L -R(T,q,P*h(1)); 
X=E; P(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P(M1,:,:,:)=2*X(M1,:,:,:); M=M -R(T,q,P*h(1));
X=F; P(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P(M1,:,:,:)=2*X(M1,:,:,:); N=N -R(T,q,P*h(1)); 
X=G; P(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P(M1,:,:,:)=2*X(M1,:,:,:); O=O -R(T,q,P*h(1)); 
X=H; P(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:);P(M1,:,:,:)=2*X(M1,:,:,:); S=S -R(T,q,P*h(1)); 

Y = zeros(N1,N2,N3,N4);
Y(1:2:N1, 1:2:N2, 1:2:N3, 1:2:N4) = A;
Y(1:2:N1, 1:2:N2, 1:2:N3, 2:2:N4) = B;
Y(1:2:N1, 1:2:N2, 2:2:N3, 1:2:N4) = C;
Y(1:2:N1, 1:2:N2, 2:2:N3, 2:2:N4) = D;
Y(1:2:N1, 2:2:N2, 1:2:N3, 1:2:N4) = E;
Y(1:2:N1, 2:2:N2, 1:2:N3, 2:2:N4) = F;
Y(1:2:N1, 2:2:N2, 2:2:N3, 1:2:N4) = G;
Y(1:2:N1, 2:2:N2, 2:2:N3, 2:2:N4) = H;
Y(2:2:N1, 1:2:N2, 1:2:N3, 1:2:N4) = I;
Y(2:2:N1, 1:2:N2, 1:2:N3, 2:2:N4) = J;
Y(2:2:N1, 1:2:N2, 2:2:N3, 1:2:N4) = K;
Y(2:2:N1, 1:2:N2, 2:2:N3, 2:2:N4) = L;
Y(2:2:N1, 2:2:N2, 1:2:N3, 1:2:N4) = M;
Y(2:2:N1, 2:2:N2, 1:2:N3, 2:2:N4) = N;
Y(2:2:N1, 2:2:N2, 2:2:N3, 1:2:N4) = O;
Y(2:2:N1, 2:2:N2, 2:2:N3, 2:2:N4) = S;

end

