function [Y A B C D E F G H I J K L M N O S]= Dwt97_Nsp2D3D(Y,Sw,Fs,Fc,T)
%
%  Non Separable 2D&3D Lifting (9/7)
%  

q=2^Fs;
[N1, N2, N3, N4]=size(Y); M1=N1/2; M2=N2/2; M3=N3/2; M4=N4/2;

g=DwtCoef(1);% 0.5/3, 1.9/7
h=floor(g.*2^Fc)./2^Fc;



%% Analysis

if(Sw==+1)

A=Y(1:2:N1, 1:2:N2, 1:2:N3, 1:2:N4);
B=Y(1:2:N1, 1:2:N2, 1:2:N3, 2:2:N4);
C=Y(1:2:N1, 1:2:N2, 2:2:N3, 1:2:N4);
D=Y(1:2:N1, 1:2:N2, 2:2:N3, 2:2:N4);
E=Y(1:2:N1, 2:2:N2, 1:2:N3, 1:2:N4);
F=Y(1:2:N1, 2:2:N2, 1:2:N3, 2:2:N4);
G=Y(1:2:N1, 2:2:N2, 2:2:N3, 1:2:N4);
H=Y(1:2:N1, 2:2:N2, 2:2:N3, 2:2:N4);
I=Y(2:2:N1, 1:2:N2, 1:2:N3, 1:2:N4);
J=Y(2:2:N1, 1:2:N2, 1:2:N3, 2:2:N4);
K=Y(2:2:N1, 1:2:N2, 2:2:N3, 1:2:N4);
L=Y(2:2:N1, 1:2:N2, 2:2:N3, 2:2:N4);
M=Y(2:2:N1, 2:2:N2, 1:2:N3, 1:2:N4);
N=Y(2:2:N1, 2:2:N2, 1:2:N3, 2:2:N4);
O=Y(2:2:N1, 2:2:N2, 2:2:N3, 1:2:N4);
S=Y(2:2:N1, 2:2:N2, 2:2:N3, 2:2:N4);

% 1st Lifting
%---------------------------
% M
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % A1 B1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1) 
P=P+X*h(1)*h(1);

X=E; % A1
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
P=P+X*h(1);

X=I; % B1 
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
P=P+X*h(1);

M=M+R(T,q,P);

%---------------------------
% N
%---------------------------
P=zeros(M1,M2,M3,M4);

X=B; % A1 B1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1) 
P=P+X*h(1)*h(1);

X=F; % A1
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
P=P+X*h(1);

X=J; % B1 
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
P=P+X*h(1);

N=N+R(T,q,P);

%---------------------------
% O
%---------------------------
P=zeros(M1,M2,M3,M4);

X=C; % A1 B1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1) 
P=P+X*h(1)*h(1);

X=G; % A1
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
P=P+X*h(1);

X=K; % B1 
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
P=P+X*h(1);

O=O+R(T,q,P);

%---------------------------
% S
%---------------------------
P=zeros(M1,M2,M3,M4);

X=D; % A1 B1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1) 
P=P+X*h(1)*h(1);

X=H; % A1
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
P=P+X*h(1);

X=L; % B1 
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
P=P+X*h(1);

S=S+R(T,q,P);

%2nd lifting
%---------------------------
% I
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % A1
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
P=P+X*h(1);

X=M; % B2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
P=P+X*h(2);

I=I+R(T,q,P);
%---------------------------
% J
%---------------------------
P=zeros(M1,M2,M3,M4);

X=B; % A1
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
P=P+X*h(1);

X=N; % B2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
P=P+X*h(2);

J=J+R(T,q,P);
%---------------------------
% K
%---------------------------
P=zeros(M1,M2,M3,M4);
X=C; % A1
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
P=P+X*h(1);

X=O; % B2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
P=P+X*h(2);

K=K+R(T,q,P);
%---------------------------
% L
%---------------------------
P=zeros(M1,M2,M3,M4);

X=D; % A1
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
P=P+X*h(1);

X=S; % B2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
P=P+X*h(2);

L=L+R(T,q,P);
%---------------------------
% E
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % B1 
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
P=P+X*h(1);

X=M; % A2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
P=P+X*h(2);

E=E+R(T,q,P);
%---------------------------
% F
%---------------------------
P=zeros(M1,M2,M3,M4);

X=B; % B1 
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
P=P+X*h(1);

X=N; % A2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
P=P+X*h(2);

F=F+R(T,q,P);
%---------------------------
% G
%---------------------------
P=zeros(M1,M2,M3,M4);

X=C; % B1 
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
P=P+X*h(1);

X=O; % A2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
P=P+X*h(2);

G=G+R(T,q,P);
%---------------------------
% H
%---------------------------
P=zeros(M1,M2,M3,M4);

X=D; % B1 
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
P=P+X*h(1);

X=S; % A2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
P=P+X*h(2);

H=H+R(T,q,P);

%3rd Lifting
%---------------------------
% A
%---------------------------
P=zeros(M1,M2,M3,M4);

X=E; % B2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
P=P+X*h(2);

X=I; % A2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
P=P+X*h(2);

X=M; % -A2 B2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1) 
P=P -X*h(2)*h(2);

A=A+R(T,q,P);

%---------------------------
% B
%---------------------------
P=zeros(M1,M2,M3,M4);

X=F; % B2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
P=P+X*h(2);

X=J; % A2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
P=P+X*h(2);

X=N; % -A2 B2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1) 
P=P -X*h(2)*h(2);

B=B+R(T,q,P);

%---------------------------
% C
%---------------------------
P=zeros(M1,M2,M3,M4);

X=G; % B2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
P=P+X*h(2);

X=K; % A2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
P=P+X*h(2);

X=O; % -A2 B2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1) 
P=P -X*h(2)*h(2);

C=C+R(T,q,P);
%---------------------------
% D
%---------------------------
P=zeros(M1,M2,M3,M4);

X=H; % B2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
P=P+X*h(2);

X=L; % A2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
P=P+X*h(2);

X=S; % -A2 B2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1) 
P=P -X*h(2)*h(2);

D=D+R(T,q,P);

%4th Lifting
%---------------------------
% S
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % A3 B3 C1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)  
P=P+X*h(3)*h(3)*h(1);

X=D; % A3 B3 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1) 
P=P+X*h(3)*h(3);

X=F; % A3 C1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(3)*h(1);

X=H; % A3
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
P=P+X*h(3);

X=J; % B3 C1
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(3)*h(1);

X=L; % B3 
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
P=P+X*h(3);

X=N; %C1
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(1);

S=S+R(T,q,P);

%5th Lifting
%---------------------------
% N
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % A3 B3 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1) 
P=P+X*h(3)*h(3);

X=F; % A3
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
P=P+X*h(3);

X=J; % B3 
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
P=P+X*h(3);

X=S; % C2
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P+X*h(2);

N=N+R(T,q,P);

%---------------------------
% L
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % A3 C1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(3)*h(1);

X=D; % A3
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
P=P+X*h(3);

X=J; % C1
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(1);

X=S; % B4
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
P=P+X*h(4);

L=L+R(T,q,P);

%---------------------------
% H
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % B3 C1
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(3)*h(1);

X=D; % B3 
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
P=P+X*h(3);

X=F; % C1
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(1);

X=S; % A4
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
P=P+X*h(4);

H=H+R(T,q,P);

%6th Lifting
%---------------------------
% I
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % A3
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
P=P+X*h(3);

X=K; % C2
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P+X*h(2);

X=M; % B4
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
P=P+X*h(4);

X=S; % -B4 C2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P -X*h(4)*h(2);

I=I+R(T,q,P);

%---------------------------
% E
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % B3 
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
P=P+X*h(3);

X=G; % C2
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P+X*h(2);

X=M; % A4
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
P=P+X*h(4);

X=S; % -A4 C2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P -X*h(4)*h(2);

E=E+R(T,q,P);

%---------------------------
% C
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % C1
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(1);

X=G; % B4
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
P=P+X*h(4);

X=K; % A4
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
P=P+X*h(4);

X=S; % -A4 B4
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1) 
P=P -X*h(4)*h(4);

C=C+R(T,q,P);

% 7th
%---------------------------
% A
%---------------------------
P=zeros(M1,M2,M3,M4);

X=C; % C2
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P+X*h(2);

X=E; % B4
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
P=P+X*h(4);

X=G; % -B4 C2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P -X*h(4)*h(2);

X=I; % A4
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
P=P+X*h(4);

X=K; % -A4 C2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P -X*h(4)*h(2);

X=M; % -A4 B4
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1) 
P=P -X*h(4)*h(4);

X=S; % A4 B4 C2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1) 
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P+X*h(4)*h(4)*h(2);

A=A+R(T,q,P);

%8th
%---------------------------
% D
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; %C3 D1
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(3)*h(1);

X=B; % C3
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(3);

X=C; % D1
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1);

D=D+R(T,q,P);
%---------------------------
% H
%---------------------------
P=zeros(M1,M2,M3,M4);

X=E; %C3 D1
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(3)*h(1);

X=F; % C3
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(3);

X=G; % D1
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1);

H=H+R(T,q,P);
%---------------------------
% L
%---------------------------
P=zeros(M1,M2,M3,M4);

X=I; %C3 D1
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(3)*h(1);

X=J; % C3
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(3);

X=K; % D1
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1);

L=L+R(T,q,P);
%---------------------------
% S
%---------------------------
P=zeros(M1,M2,M3,M4);

X=M; %C3 D1
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(3)*h(1);

X=N; % C3
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(3);

X=O; % D1
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1);

S=S+R(T,q,P);

%9th
%---------------------------
% C
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % C3
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(3);

X=D; % D2
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P+X*h(2);

C=C+R(T,q,P);

%---------------------------
% G
%---------------------------
P=zeros(M1,M2,M3,M4);

X=E; % C3
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(3);

X=H; % D2
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P+X*h(2);

G=G+R(T,q,P);
%---------------------------
% K
%---------------------------
P=zeros(M1,M2,M3,M4);

X=I; % C3
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(3);

X=L; % D2
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P+X*h(2);

K=K+R(T,q,P);
%---------------------------
% O
%---------------------------
P=zeros(M1,M2,M3,M4);

X=M; % C3
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(3);

X=S; % D2
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P+X*h(2);

O=O+R(T,q,P);

%---------------------------
% B
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % D1
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1);

X=D; % C4
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P+X*h(4);

B=B+R(T,q,P);
%---------------------------
% F
%---------------------------
P=zeros(M1,M2,M3,M4);

X=E; % D1
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1);

X=H; % C4
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P+X*h(4);

F=F+R(T,q,P);
%---------------------------
% J
%---------------------------
P=zeros(M1,M2,M3,M4);

X=I; % D1
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1);

X=L; % C4
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P+X*h(4);

J=J+R(T,q,P);
%---------------------------
% N
%---------------------------
P=zeros(M1,M2,M3,M4);

X=M; % D1
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1);

X=S; % C4
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P+X*h(4);

N=N+R(T,q,P);

%10th
%---------------------------
% A
%---------------------------
P=zeros(M1,M2,M3,M4);

X=B; % D2
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P+X*h(2);

X=C; % C4
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P+X*h(4);

X=D; % -C4 D2
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P -X*h(4)*h(2);

A=A+R(T,q,P);
%---------------------------
% E
%---------------------------
P=zeros(M1,M2,M3,M4);

X=F; % D2
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P+X*h(2);

X=G; % C4
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P+X*h(4);

X=H; % -C4 D2
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P -X*h(4)*h(2);

E=E+R(T,q,P);
%---------------------------
% I
%---------------------------
P=zeros(M1,M2,M3,M4);

X=J; % D2
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P+X*h(2);

X=K; % C4
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P+X*h(4);

X=L; % -C4 D2
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P -X*h(4)*h(2);

I=I+R(T,q,P);
%---------------------------
% M
%---------------------------
P=zeros(M1,M2,M3,M4);

X=N; % D2
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P+X*h(2);

X=O; % C4
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P+X*h(4);

X=S; % -C4 D2
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P -X*h(4)*h(2);

M=M+R(T,q,P);

%11th
P=zeros(M1,M2,M3,M4);

X=A; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); B=B +R(T,q,P*h(3)); 
X=C; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); D=D +R(T,q,P*h(3)); 
X=E; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); F=F +R(T,q,P*h(3)); 
X=G; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); H=H +R(T,q,P*h(3)); 
X=I; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); J=J +R(T,q,P*h(3)); 
X=K; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); L=L +R(T,q,P*h(3)); 
X=M; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); N=N +R(T,q,P*h(3)); 
X=O; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); S=S +R(T,q,P*h(3)); 

%12th
X=B; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); A=A +R(T,q,P*h(4)); 
X=D; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); C=C +R(T,q,P*h(4)); 
X=F; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); E=E +R(T,q,P*h(4)); 
X=H; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); G=G +R(T,q,P*h(4)); 
X=J; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); I=I +R(T,q,P*h(4)); 
X=L; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); K=K +R(T,q,P*h(4)); 
X=N; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); M=M +R(T,q,P*h(4));
X=S; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); O=O +R(T,q,P*h(4)); 

A=R(T,q,A*h(6)*h(6)*h(6)*h(6));
B=R(T,q,B*h(6)*h(6));
C=R(T,q,C*h(6)*h(6));
D=R(T,q,D);
E=R(T,q,E*h(6)*h(6));
F=R(T,q,F);
G=R(T,q,G);
H=R(T,q,H*h(5)*h(5));
I=R(T,q,I*h(6)*h(6));
J=R(T,q,J);
K=R(T,q,K);
L=R(T,q,L*h(5)*h(5));
M=R(T,q,M);
N=R(T,q,N*h(5)*h(5));
O=R(T,q,O*h(5)*h(5));
S=R(T,q,S*h(5)*h(5)*h(5)*h(5));

% ===================== RECONSTRUCTION
Z(   1:M1,    1:M2,    1:M3,    1:M4) = A;
Z(   1:M1,    1:M2,    1:M3, 1+M4:N4) = B;
Z(   1:M1,    1:M2, 1+M3:N3,    1:M4) = C;
Z(   1:M1,    1:M2, 1+M3:N3, 1+M4:N4) = D;
Z(   1:M1, 1+M2:N2,    1:M3,    1:M4) = E;
Z(   1:M1, 1+M2:N2,    1:M3, 1+M4:N4) = F;
Z(   1:M1, 1+M2:N2, 1+M3:N3,    1:M4) = G;
Z(   1:M1, 1+M2:N2, 1+M3:N3, 1+M4:N4) = H;
Z(1+M1:N1,    1:M2,    1:M3,    1:M4) = I;
Z(1+M1:N1,    1:M2,    1:M3, 1+M4:N4) = J;
Z(1+M1:N1,    1:M2, 1+M3:N3,    1:M4) = K;
Z(1+M1:N1,    1:M2, 1+M3:N3, 1+M4:N4) = L;
Z(1+M1:N1, 1+M2:N2,    1:M3,    1:M4) = M;
Z(1+M1:N1, 1+M2:N2,    1:M3, 1+M4:N4) = N;
Z(1+M1:N1, 1+M2:N2, 1+M3:N3,    1:M4) = O;
Z(1+M1:N1, 1+M2:N2, 1+M3:N3, 1+M4:N4) = S;

Y = Z;

end

%% Synthesis
if(Sw==-1) 

A = Y(   1:M1,    1:M2,    1:M3,    1:M4);
B = Y(   1:M1,    1:M2,    1:M3, 1+M4:N4);
C = Y(   1:M1,    1:M2, 1+M3:N3,    1:M4);
D = Y(   1:M1,    1:M2, 1+M3:N3, 1+M4:N4);
E = Y(   1:M1, 1+M2:N2,    1:M3,    1:M4);
F = Y(   1:M1, 1+M2:N2,    1:M3, 1+M4:N4);
G = Y(   1:M1, 1+M2:N2, 1+M3:N3,    1:M4);
H = Y(   1:M1, 1+M2:N2, 1+M3:N3, 1+M4:N4);
I = Y(1+M1:N1,    1:M2,    1:M3,    1:M4);
J = Y(1+M1:N1,    1:M2,    1:M3, 1+M4:N4);
K = Y(1+M1:N1,    1:M2, 1+M3:N3,    1:M4);
L = Y(1+M1:N1,    1:M2, 1+M3:N3, 1+M4:N4);
M = Y(1+M1:N1, 1+M2:N2,    1:M3,    1:M4);
N = Y(1+M1:N1, 1+M2:N2,    1:M3, 1+M4:N4);
O = Y(1+M1:N1, 1+M2:N2, 1+M3:N3,    1:M4);
S = Y(1+M1:N1, 1+M2:N2, 1+M3:N3, 1+M4:N4);

A=R(T,q,A*h(5)*h(5)*h(5)*h(5));
B=R(T,q,B*h(5)*h(5));
C=R(T,q,C*h(5)*h(5));
D=R(T,q,D);
E=R(T,q,E*h(5)*h(5));
F=R(T,q,F);
G=R(T,q,G);
H=R(T,q,H*h(6)*h(6));
I=R(T,q,I*h(5)*h(5));
J=R(T,q,J);
K=R(T,q,K);
L=R(T,q,L*h(6)*h(6));
M=R(T,q,M);
N=R(T,q,N*h(6)*h(6));
O=R(T,q,O*h(6)*h(6));
S=R(T,q,S*h(6)*h(6)*h(6)*h(6));

P=zeros(M1,M2,M3,M4);

%12th
X=B; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); A=A -R(T,q,P*h(4)); 
X=D; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); C=C -R(T,q,P*h(4)); 
X=F; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); E=E -R(T,q,P*h(4)); 
X=H; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); G=G -R(T,q,P*h(4)); 
X=J; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); I=I -R(T,q,P*h(4)); 
X=L; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); K=K -R(T,q,P*h(4)); 
X=N; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); M=M -R(T,q,P*h(4));
X=S; P(:,:,:  ,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:, 1)=2*X(:,:,:, 1); O=O -R(T,q,P*h(4)); 

%11th
X=A; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); B=B -R(T,q,P*h(3)); 
X=C; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); D=D -R(T,q,P*h(3)); 
X=E; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); F=F -R(T,q,P*h(3)); 
X=G; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); H=H -R(T,q,P*h(3)); 
X=I; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); J=J -R(T,q,P*h(3)); 
X=K; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); L=L -R(T,q,P*h(3)); 
X=M; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); N=N -R(T,q,P*h(3)); 
X=O; P(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4);P(:,:,:,M4)=2*X(:,:,:,M4); S=S -R(T,q,P*h(3)); 

%10th
%---------------------------
% A
%---------------------------
P=zeros(M1,M2,M3,M4);

X=B; % D2
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P+X*h(2);

X=C; % C4
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P+X*h(4);

X=D; % -C4 D2
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P -X*h(4)*h(2);

A=A-R(T,q,P);
%---------------------------
% E
%---------------------------
P=zeros(M1,M2,M3,M4);

X=F; % D2
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P+X*h(2);

X=G; % C4
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P+X*h(4);

X=H; % -C4 D2
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P -X*h(4)*h(2);

E=E-R(T,q,P);
%---------------------------
% I
%---------------------------
P=zeros(M1,M2,M3,M4);

X=J; % D2
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P+X*h(2);

X=K; % C4
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P+X*h(4);

X=L; % -C4 D2
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P -X*h(4)*h(2);

I=I-R(T,q,P);
%---------------------------
% M
%---------------------------
P=zeros(M1,M2,M3,M4);

X=N; % D2
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P+X*h(2);

X=O; % C4
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P+X*h(4);

X=S; % -C4 D2
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P -X*h(4)*h(2);

M=M-R(T,q,P);

%9th
%---------------------------
% C
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % C3
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(3);

X=D; % D2
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P+X*h(2);

C=C-R(T,q,P);

%---------------------------
% G
%---------------------------
P=zeros(M1,M2,M3,M4);

X=E; % C3
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(3);

X=H; % D2
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P+X*h(2);

G=G-R(T,q,P);
%---------------------------
% K
%---------------------------
P=zeros(M1,M2,M3,M4);

X=I; % C3
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(3);

X=L; % D2
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P+X*h(2);

K=K-R(T,q,P);
%---------------------------
% O
%---------------------------
P=zeros(M1,M2,M3,M4);

X=M; % C3
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(3);

X=S; % D2
X(:,:,:,2:M4)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,1)=2*X(:,:,:,1);% (1+z4^-1)  
P=P+X*h(2);

O=O-R(T,q,P);

%---------------------------
% B
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % D1
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1);

X=D; % C4
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P+X*h(4);

B=B-R(T,q,P);
%---------------------------
% F
%---------------------------
P=zeros(M1,M2,M3,M4);

X=E; % D1
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1);

X=H; % C4
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P+X*h(4);

F=F-R(T,q,P);
%---------------------------
% J
%---------------------------
P=zeros(M1,M2,M3,M4);

X=I; % D1
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1);

X=L; % C4
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P+X*h(4);

J=J-R(T,q,P);
%---------------------------
% N
%---------------------------
P=zeros(M1,M2,M3,M4);

X=M; % D1
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1);

X=S; % C4
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P+X*h(4);

N=N-R(T,q,P);

%8th
%---------------------------
% D
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; %C3 D1
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(3)*h(1);

X=B; % C3
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(3);

X=C; % D1
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1);

D=D-R(T,q,P);
%---------------------------
% H
%---------------------------
P=zeros(M1,M2,M3,M4);

X=E; %C3 D1
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(3)*h(1);

X=F; % C3
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(3);

X=G; % D1
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1);

H=H-R(T,q,P);
%---------------------------
% L
%---------------------------
P=zeros(M1,M2,M3,M4);

X=I; %C3 D1
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(3)*h(1);

X=J; % C3
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(3);

X=K; % D1
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1);

L=L-R(T,q,P);
%---------------------------
% S
%---------------------------
P=zeros(M1,M2,M3,M4);

X=M; %C3 D1
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(3)*h(1);

X=N; % C3
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(3);

X=O; % D1
X(:,:,:,1:M4-1)=X(:,:,:,1:M4-1)+X(:,:,:,2:M4); X(:,:,:,M4)=2*X(:,:,:,M4);% (1+z4^+1)  
P=P+X*h(1);

S=S-R(T,q,P);

% 7th
%---------------------------
% A
%---------------------------
P=zeros(M1,M2,M3,M4);

X=C; % C2
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P+X*h(2);

X=E; % B4
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
P=P+X*h(4);

X=G; % -B4 C2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P -X*h(4)*h(2);

X=I; % A4
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
P=P+X*h(4);

X=K; % -A4 C2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P -X*h(4)*h(2);

X=M; % -A4 B4
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1) 
P=P -X*h(4)*h(4);

X=S; % A4 B4 C2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1) 
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P+X*h(4)*h(4)*h(2);

A=A-R(T,q,P);

%6th Lifting
%---------------------------
% I
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % A3
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
P=P+X*h(3);

X=K; % C2
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P+X*h(2);

X=M; % B4
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
P=P+X*h(4);

X=S; % -B4 C2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P -X*h(4)*h(2);

I=I-R(T,q,P);

%---------------------------
% E
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % B3 
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
P=P+X*h(3);

X=G; % C2
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P+X*h(2);

X=M; % A4
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
P=P+X*h(4);

X=S; % -A4 C2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P -X*h(4)*h(2);

E=E-R(T,q,P);

%---------------------------
% C
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % C1
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(1);

X=G; % B4
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
P=P+X*h(4);

X=K; % A4
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
P=P+X*h(4);

X=S; % -A4 B4
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1) 
P=P -X*h(4)*h(4);

C=C-R(T,q,P);

%5th Lifting
%---------------------------
% N
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % A3 B3 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1) 
P=P+X*h(3)*h(3);

X=F; % A3
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
P=P+X*h(3);

X=J; % B3 
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
P=P+X*h(3);

X=S; % C2
X(:,:,2:M3,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,1,:)=2*X(:,:,1,:);% (1+z3^-1)  
P=P+X*h(2);

N=N-R(T,q,P);

%---------------------------
% L
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % A3 C1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(3)*h(1);

X=D; % A3
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
P=P+X*h(3);

X=J; % C1
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(1);

X=S; % B4
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
P=P+X*h(4);

L=L-R(T,q,P);

%---------------------------
% H
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % B3 C1
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(3)*h(1);

X=D; % B3 
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
P=P+X*h(3);

X=F; % C1
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(1);

X=S; % A4
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
P=P+X*h(4);

H=H-R(T,q,P);

%4th Lifting
%---------------------------
% S
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % A3 B3 C1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)  
P=P+X*h(3)*h(3)*h(1);

X=D; % A3 B3 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1) 
P=P+X*h(3)*h(3);

X=F; % A3 C1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(3)*h(1);

X=H; % A3
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
P=P+X*h(3);

X=J; % B3 C1
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(3)*h(1);

X=L; % B3 
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
P=P+X*h(3);

X=N; %C1
X(:,:,1:M3-1,:)=X(:,:,1:M3-1,:)+X(:,:,2:M3,:); X(:,:,M3,:)=2*X(:,:,M3,:);% (1+z3^+1)
P=P+X*h(1);

S=S-R(T,q,P);

%3rd Lifting
%---------------------------
% A
%---------------------------
P=zeros(M1,M2,M3,M4);

X=E; % B2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
P=P+X*h(2);

X=I; % A2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
P=P+X*h(2);

X=M; % -A2 B2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1) 
P=P -X*h(2)*h(2);

A=A-R(T,q,P);

%---------------------------
% B
%---------------------------
P=zeros(M1,M2,M3,M4);

X=F; % B2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
P=P+X*h(2);

X=J; % A2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
P=P+X*h(2);

X=N; % -A2 B2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1) 
P=P -X*h(2)*h(2);

B=B-R(T,q,P);

%---------------------------
% C
%---------------------------
P=zeros(M1,M2,M3,M4);

X=G; % B2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
P=P+X*h(2);

X=K; % A2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
P=P+X*h(2);

X=O; % -A2 B2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1) 
P=P -X*h(2)*h(2);

C=C-R(T,q,P);
%---------------------------
% D
%---------------------------
P=zeros(M1,M2,M3,M4);

X=H; % B2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
P=P+X*h(2);

X=L; % A2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
P=P+X*h(2);

X=S; % -A2 B2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1) 
P=P -X*h(2)*h(2);

D=D-R(T,q,P);

%2nd lifting
%---------------------------
% I
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % A1
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
P=P+X*h(1);

X=M; % B2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
P=P+X*h(2);

I=I-R(T,q,P);
%---------------------------
% J
%---------------------------
P=zeros(M1,M2,M3,M4);

X=B; % A1
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
P=P+X*h(1);

X=N; % B2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
P=P+X*h(2);

J=J-R(T,q,P);
%---------------------------
% K
%---------------------------
P=zeros(M1,M2,M3,M4);
X=C; % A1
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
P=P+X*h(1);

X=O; % B2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
P=P+X*h(2);

K=K-R(T,q,P);
%---------------------------
% L
%---------------------------
P=zeros(M1,M2,M3,M4);

X=D; % A1
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
P=P+X*h(1);

X=S; % B2
X(:,2:M2,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,1,:,:)=2*X(:,1,:,:);% (1+z2^-1)  
P=P+X*h(2);

L=L-R(T,q,P);
%---------------------------
% E
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % B1 
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
P=P+X*h(1);

X=M; % A2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
P=P+X*h(2);

E=E-R(T,q,P);
%---------------------------
% F
%---------------------------
P=zeros(M1,M2,M3,M4);

X=B; % B1 
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
P=P+X*h(1);

X=N; % A2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
P=P+X*h(2);

F=F-R(T,q,P);
%---------------------------
% G
%---------------------------
P=zeros(M1,M2,M3,M4);

X=C; % B1 
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
P=P+X*h(1);

X=O; % A2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
P=P+X*h(2);

G=G-R(T,q,P);
%---------------------------
% H
%---------------------------
P=zeros(M1,M2,M3,M4);

X=D; % B1 
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
P=P+X*h(1);

X=S; % A2
X(2:M1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(1,:,:,:)=2*X(1,:,:,:);% (1+z1^-1)  
P=P+X*h(2);

H=H-R(T,q,P);

% 1st Lifting
%---------------------------
% M
%---------------------------
P=zeros(M1,M2,M3,M4);

X=A; % A1 B1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1) 
P=P+X*h(1)*h(1);

X=E; % A1
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
P=P+X*h(1);

X=I; % B1 
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
P=P+X*h(1);

M=M-R(T,q,P);

%---------------------------
% N
%---------------------------
P=zeros(M1,M2,M3,M4);

X=B; % A1 B1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1) 
P=P+X*h(1)*h(1);

X=F; % A1
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
P=P+X*h(1);

X=J; % B1 
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
P=P+X*h(1);

N=N-R(T,q,P);

%---------------------------
% O
%---------------------------
P=zeros(M1,M2,M3,M4);

X=C; % A1 B1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1) 
P=P+X*h(1)*h(1);

X=G; % A1
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
P=P+X*h(1);

X=K; % B1 
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
P=P+X*h(1);

O=O-R(T,q,P);

%---------------------------
% S
%---------------------------
P=zeros(M1,M2,M3,M4);

X=D; % A1 B1 
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1) 
P=P+X*h(1)*h(1);

X=H; % A1
X(1:M1-1,:,:,:)=X(1:M1-1,:,:,:)+X(2:M1,:,:,:); X(M1,:,:,:)=2*X(M1,:,:,:);% (1+z1^+1)  
P=P+X*h(1);

X=L; % B1 
X(:,1:M2-1,:,:)=X(:,1:M2-1,:,:)+X(:,2:M2,:,:); X(:,M2,:,:)=2*X(:,M2,:,:);% (1+z2^+1)  
P=P+X*h(1);

S=S-R(T,q,P);

Y = zeros(N1,N2,N3,N4);
Y(1:2:N1, 1:2:N2, 1:2:N3, 1:2:N4) = A;
Y(1:2:N1, 1:2:N2, 1:2:N3, 2:2:N4) = B;
Y(1:2:N1, 1:2:N2, 2:2:N3, 1:2:N4) = C;
Y(1:2:N1, 1:2:N2, 2:2:N3, 2:2:N4) = D;
Y(1:2:N1, 2:2:N2, 1:2:N3, 1:2:N4) = E;
Y(1:2:N1, 2:2:N2, 1:2:N3, 2:2:N4) = F;
Y(1:2:N1, 2:2:N2, 2:2:N3, 1:2:N4) = G;
Y(1:2:N1, 2:2:N2, 2:2:N3, 2:2:N4) = H;
Y(2:2:N1, 1:2:N2, 1:2:N3, 1:2:N4) = I;
Y(2:2:N1, 1:2:N2, 1:2:N3, 2:2:N4) = J;
Y(2:2:N1, 1:2:N2, 2:2:N3, 1:2:N4) = K;
Y(2:2:N1, 1:2:N2, 2:2:N3, 2:2:N4) = L;
Y(2:2:N1, 2:2:N2, 1:2:N3, 1:2:N4) = M;
Y(2:2:N1, 2:2:N2, 1:2:N3, 2:2:N4) = N;
Y(2:2:N1, 2:2:N2, 2:2:N3, 1:2:N4) = O;
Y(2:2:N1, 2:2:N2, 2:2:N3, 2:2:N4) = S;


end